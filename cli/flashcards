#!/usr/bin/env node
var inquirer = require('inquirer');
var program = require('commander');
var Promise = require('bluebird');

var controller = require('../controller.js');

// Helper for start()
var promptCard = function(card) {
    var q = [
        {
            type: 'confirm',
            name: 'front',
            message: card.front + '\nPress enter to flip.'
        },
        {
            type: 'list',
            name: 'responseQuality',
            message: card.back + '\nWhat was your response score?',
            choices: [ '0', '1', '2', '3', '4', '5' ]
        }
    ];
    return inquirer.prompt(q).then(function(answers) {
        controller.logReview(card.id, answers.responseQuality);
        console.log('Logged the review');
    })
}

// CLI command implementations
var count = function(options) {
    controller.getTodaysCards().then(function(cards) {
        console.log('There are ' + cards.length + ' cards to review.');
    });
}

var start = function(options) {
    controller.getTodaysCards().then(function(cards) {
        if (cards.length === 0) {
            console.log('No cards to review.');
            process.exit(0);
        }
        console.log('Reviewing ' + cards.length + ' cards.');
        const responseQualityReminderString = 
`Response quality reminder:
 *  5 - perfect response
 *  4 - correct response after a hesitation
 *  3 - correct response recalled with serious difficulty
 *  2 - incorrect response; where the correct one seemed easy to recall
 *  1 - incorrect response; the correct one remembered
 *  0 - complete blackout`;
        console.log(responseQualityReminderString)

        Promise.reduce(cards, function(i, card) {
            return promptCard(card);
        }, 0).then(function() {
            console.log('All done!');
        });
    });
}

var newCard = function(options) {
    // todo: take a filename.
    if (!options.front || !options.back) {
        console.error('error: need both a front and a back to add a new card.');
        return;
    }

    controller.newCard(options.front, options.back).then(function() {
        console.log('Added card to db.');
    });
}

var deleteCard = function(options) {
    if (!options.front) {
        console.error('error: need a card to delete.');
        return;
    }

    controller.deleteCardByFront(options.front).then(function(ret) {
        if (ret === undefined) {
            console.log('card did not exist.');
        }
        else {
            console.log('deleted card.');
        }
    });
}

// CLI command parsing
program
    .command('count')
    .alias('ls')
    .description('list the number of reviews for today')
    .action(count);

program
    .command('start')
    .alias('go')
    .description('start reviewing flashcards')
    .action(start);

program
    .command('new')
    .option('-f, --front [front]', 'Text for the front of the card')
    .option('-b, --back [back]', 'Text for the back of the card')
    .description('make a new flashcard')
    .action(newCard);

program
    .command('delete')
    .option('-f --front [front]', 'Text on the front side of the card you wish to delete')
    .description('delete a flashcard with the given front side')
    .action(deleteCard);
    
program.parse(process.argv);
// If no command specified, show the help information
if (program.args.length === 0) {
    program.help();
}